name: "Z-AUTOMATED: Base Infrastructure Terraform Plan/Apply"

on:
  push:
    branches: [main]
    paths:
      - "stacks/container_repositories/**"
      - "stacks/base_support/**"
      - "stacks/base_networking/**"
      - "stacks/ecs_cluster/**"
      - ".github/workflows/automated-base-infrastructure-terraform.yml"
      - ".github/workflows/deploy-stack.yml"

  pull_request:
    branches: [main]
    paths:
      - "../../stacks/container_repositories/**"
      - "../../stacks/base_support/**"
      - "../../stacks/base_networking/**"
      - "../../stacks/ecs_cluster/**"
      - ".github/workflows/automated-base-infrastructure-terraform.yml"
      - ".github/workflows/deploy-stack.yml"

permissions:
  pull-requests: write
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  terraform_plan:
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        environment: [dev]
        terraform_stack:
          - name: "container_repositories"
            hyphenated_alias: container-repositories
          - name: "base_support"
            hyphenated_alias: base-support
          - name: "base_networking"
            hyphenated_alias: base-networking
          - name: "ecs_cluster"
            hyphenated_alias: ecs-cluster
    uses: ./.github/workflows/deploy-stack.yml
    with:
      environment: ${{ matrix.environment }}
      terraform_stack: ${{ matrix.terraform_stack.name }}
      is_deployment: ${{ github.ref == 'refs/heads/main' }}
      git_ref: ${{ github.ref }}
      hyphenated_alias: ${{ matrix.terraform_stack.hyphenated_alias }}
    secrets: inherit
